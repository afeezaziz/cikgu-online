{% extends "base.html" %}

{% block title %}Soalan Subjektif - {{ subject }} Bab {{ chapter }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <ol class="flex items-center space-x-2">
            <li><a href="{{ url_for('subjects') }}" class="text-primary hover:underline">Mata Pelajaran</a></li>
            <li><span class="text-gray-400">/</span></li>
            <li><a href="{{ url_for('subject_detail', subject=subject) }}" class="text-primary hover:underline">{{ subject }}</a></li>
            <li><span class="text-gray-400">/</span></li>
            <li><a href="{{ url_for('chapter', subject=subject, chapter=chapter) }}" class="text-primary hover:underline">Bab {{ chapter }}</a></li>
            <li><span class="text-gray-400">/</span></li>
            <li><span class="text-gray-600 font-medium">Soalan Subjektif</span></li>
        </ol>
    </nav>

    <!-- Assessment Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Soalan Subjektif & Penulisan</h1>
                <p class="text-gray-600">{{ subject }} - Bab {{ chapter }}</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">Masa Diperuntukkan</div>
                <div class="font-semibold" id="timer">{{ time_limit }}:00</div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
            <div class="bg-secondary h-2 rounded-full transition-all duration-300" style="width: 0%" id="progress-bar"></div>
        </div>
        <div class="flex justify-between text-sm text-gray-600">
            <span>Soalan <span id="current-question">1</span> daripada {{ total_questions }}</span>
            <span><span id="word-count">0</span> perkataan</span>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <h3 class="font-semibold text-green-900 mb-2">Arahan:</h3>
        <ul class="text-green-800 space-y-1 text-sm">
            <li>• Baca setiap soalan dengan teliti sebelum menjawab</li>
            <li>• Tulis jawapan dalam kotak yang disediakan</li>
            <li>• Pastikan jawapan anda jelas dan tersusun</li>
            <li>• Perhatikan had masa untuk setiap bahagian</li>
            <li>• Gunakan butang simpan secara berkala</li>
        </ul>
    </div>

    <!-- Essay Writing Section -->
    {% if essay_question %}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900">Bahagian A: Karangan</h3>
            <span class="badge badge-lg badge-secondary">{{ essay_question.marks }} markah</span>
        </div>

        <div class="mb-4">
            <h4 class="font-medium text-gray-900 mb-2">{{ essay_question.title }}</h4>
            <p class="text-gray-700 mb-4">{{ essay_question.prompt }}</p>

            {% if essay_question.guidelines %}
            <div class="bg-blue-50 rounded-lg p-4 mb-4">
                <h5 class="font-semibold text-blue-900 mb-2">Panduan:</h5>
                <ul class="text-blue-800 space-y-1 text-sm">
                    {% for guideline in essay_question.guidelines %}
                    <li>• {{ guideline }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <label class="block text-sm font-medium text-gray-700">Tulis karangan anda di sini:</label>
                <div class="flex items-center space-x-4 text-sm text-gray-500">
                    <span>Perkataan: <span id="essay-word-count">0</span></span>
                    <span>Aksara: <span id="essay-char-count">0</span></span>
                </div>
            </div>

            <textarea
                id="essay-answer"
                name="essay_answer"
                class="w-full h-64 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent resize-none"
                placeholder="Mula menulis karangan anda di sini..."
                oninput="updateWordCount('essay-answer', 'essay-word-count', 'essay-char-count')"
            ></textarea>
        </div>
    </div>
    {% endif %}

    <!-- Subjective Questions Form -->
    <form id="subjective-form" class="space-y-6">
        <!-- Structured Questions -->
        {% for question in subjective_questions %}
        <div class="question-card bg-white rounded-lg shadow-sm border border-gray-200 p-6" data-question-id="{{ question.id }}">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">
                        Soalan {{ loop.index + (1 if essay_question else 0) }}: {{ question.question }}
                    </h3>
                    {% if question.marks %}
                    <span class="badge badge-sm badge-secondary">{{ question.marks }} markah</span>
                    {% endif %}
                </div>
                <div class="ml-4 text-right">
                    <div class="text-sm text-gray-500">Perkataan</div>
                    <div class="font-semibold" id="word-count-{{ question.id }}">0</div>
                </div>
            </div>

            <!-- Question Context (if any) -->
            {% if question.context %}
            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <h4 class="font-medium text-gray-900 mb-2">Konteks:</h4>
                <p class="text-gray-700">{{ question.context }}</p>
            </div>
            {% endif %}

            <!-- Answer Input -->
            <div class="space-y-4">
                {% if question.type == 'short' %}
                <input
                    type="text"
                    name="answer_{{ question.id }}"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent"
                    placeholder="Jawapan pendek..."
                    maxlength="200"
                >
                {% elif question.type == 'paragraph' %}
                <textarea
                    name="answer_{{ question.id }}"
                    class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent resize-none"
                    placeholder="Tulis jawapan anda dalam satu perenggan..."
                    oninput="updateWordCount('answer_{{ question.id }}', 'word-count-{{ question.id }}')"
                ></textarea>
                {% elif question.type == 'essay' %}
                <textarea
                    name="answer_{{ question.id }}"
                    class="w-full h-48 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-secondary focus:border-transparent resize-none"
                    placeholder="Tulis jawapan terperinci anda di sini..."
                    oninput="updateWordCount('answer_{{ question.id }}', 'word-count-{{ question.id }}')"
                ></textarea>
                {% endif %}

                <!-- Word limit indicator -->
                {% if question.min_words or question.max_words %}
                <div class="text-sm text-gray-500">
                    {% if question.min_words %}Minimum: {{ question.min_words }} perkataan{% endif %}
                    {% if question.min_words and question.max_words %} | {% endif %}
                    {% if question.max_words %}Maksimum: {{ question.max_words }} perkataan{% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Writing Tips (if any) -->
            {% if question.tips %}
            <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                <h4 class="font-semibold text-yellow-900 mb-2">Tips:</h4>
                <ul class="text-yellow-800 space-y-1 text-sm">
                    {% for tip in question.tips %}
                    <li>• {{ tip }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        <!-- Auto-save Notice -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-blue-800 text-sm">
                    Jawapan anda akan disimpan secara automatik setiap 30 saat
                </span>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="flex justify-between items-center pt-6 border-t border-gray-200">
            <div class="space-x-3">
                <button type="button" id="save-btn" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    Simpan Draf
                </button>
                <button type="button" id="preview-btn" class="btn btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Pratonton
                </button>
            </div>
            <button type="submit" id="submit-btn" class="btn btn-secondary btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Hantar Jawapan
            </button>
        </div>
    </form>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[80vh] overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Pratonton Jawapan</h3>
                    <button type="button" onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div id="preview-content" class="space-y-6">
                    <!-- Preview content will be populated here -->
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closePreviewModal()" class="btn btn-outline">Kembali</button>
                    <button type="button" onclick="submitFromPreview()" class="btn btn-secondary">Hantar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let timeLimit = {{ time_limit }} * 60; // Convert to seconds
let timer = setInterval(updateTimer, 1000);
let autoSaveTimer = setInterval(autoSave, 30000); // Auto-save every 30 seconds
let totalQuestions = {{ total_questions }};

function updateTimer() {
    timeLimit--;
    const minutes = Math.floor(timeLimit / 60);
    const seconds = timeLimit % 60;
    document.getElementById('timer').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;

    if (timeLimit <= 0) {
        clearInterval(timer);
        clearInterval(autoSaveTimer);
        submitAssessment();
    }
}

function updateWordCount(textareaId, wordCountId, charCountId = null) {
    const textarea = document.getElementById(textareaId);
    const text = textarea.value.trim();

    // Count words (split by whitespace and filter out empty strings)
    const words = text ? text.split(/\s+/).filter(word => word.length > 0) : [];
    const wordCount = words.length;

    // Update word count
    document.getElementById(wordCountId).textContent = wordCount;

    // Update character count if provided
    if (charCountId) {
        document.getElementById(charCountId).textContent = text.length;
    }

    // Update total word count
    updateTotalWordCount();
}

function updateTotalWordCount() {
    let totalWords = 0;

    // Count essay words
    const essayText = document.getElementById('essay-answer');
    if (essayText) {
        const essayWords = essayText.value.trim().split(/\s+/).filter(word => word.length > 0);
        totalWords += essayWords.length;
    }

    // Count subjective question words
    document.querySelectorAll('textarea[name^="answer_"]').forEach(textarea => {
        const text = textarea.value.trim();
        if (text) {
            const words = text.split(/\s+/).filter(word => word.length > 0);
            totalWords += words.length;
        }
    });

    document.getElementById('word-count').textContent = totalWords;
}

function autoSave() {
    const formData = new FormData(document.getElementById('subjective-form'));
    const answers = {};

    // Collect all answers
    formData.forEach((value, key) => {
        answers[key] = value;
    });

    // Include essay answer if exists
    const essayAnswer = document.getElementById('essay-answer');
    if (essayAnswer) {
        answers['essay_answer'] = essayAnswer.value;
    }

    fetch('/api/save-subjective-draft', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            subject: '{{ subject }}',
            chapter: {{ chapter }},
            answers: answers,
            time_spent: {{ time_limit }} * 60 - timeLimit
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show auto-save notification
            showNotification('Draf disimpan secara automatik', 'success');
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
    });
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function showPreviewModal() {
    const previewContent = document.getElementById('preview-content');
    previewContent.innerHTML = '';

    // Add essay preview if exists
    const essayAnswer = document.getElementById('essay-answer');
    if (essayAnswer && essayAnswer.value.trim()) {
        const essaySection = document.createElement('div');
        essaySection.className = 'mb-6';
        essaySection.innerHTML = `
            <h4 class="text-lg font-semibold text-gray-900 mb-2">Karangan</h4>
            <div class="bg-gray-50 p-4 rounded-lg">
                <p class="whitespace-pre-wrap text-gray-800">${essayAnswer.value}</p>
            </div>
        `;
        previewContent.appendChild(essaySection);
    }

    // Add subjective question previews
    document.querySelectorAll('.question-card').forEach((card, index) => {
        const questionId = card.dataset.questionId;
        const questionText = card.querySelector('h3').textContent;
        const answerField = card.querySelector('input, textarea');

        if (answerField && answerField.value.trim()) {
            const questionSection = document.createElement('div');
            questionSection.className = 'mb-6';
            questionSection.innerHTML = `
                <h4 class="text-lg font-semibold text-gray-900 mb-2">${questionText}</h4>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="whitespace-pre-wrap text-gray-800">${answerField.value}</p>
                </div>
            `;
            previewContent.appendChild(questionSection);
        }
    });

    document.getElementById('preview-modal').classList.remove('hidden');
}

function closePreviewModal() {
    document.getElementById('preview-modal').classList.add('hidden');
}

function submitFromPreview() {
    closePreviewModal();
    submitAssessment();
}

function submitAssessment() {
    clearInterval(timer);
    clearInterval(autoSaveTimer);

    const formData = new FormData(document.getElementById('subjective-form'));
    const answers = {};

    // Collect all answers
    formData.forEach((value, key) => {
        answers[key] = value;
    });

    // Include essay answer if exists
    const essayAnswer = document.getElementById('essay-answer');
    if (essayAnswer) {
        answers['essay_answer'] = essayAnswer.value;
    }

    // Submit to server
    fetch('/api/submit-subjective', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            subject: '{{ subject }}',
            chapter: {{ chapter }},
            answers: answers,
            time_spent: {{ time_limit }} * 60 - timeLimit
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to confirmation page
            window.location.href = `/subjective-results/${data.attempt_id}`;
        } else {
            alert('Ralat semasa menghantar jawapan: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ralat semasa menghantar jawapan');
    });
}

// Event listeners
document.getElementById('save-btn').addEventListener('click', autoSave);
document.getElementById('preview-btn').addEventListener('click', showPreviewModal);
document.getElementById('subjective-form').addEventListener('submit', function(e) {
    e.preventDefault();
    showPreviewModal();
});

// Initialize
updateTotalWordCount();
</script>
{% endblock %}